<h1>投稿詳細</h1>

<div class="card">
  <div class="card-body">
    <h5 class="card-title">投稿者: <%= link_to @post.user.name, user_path(@post.user) %></h5>
    <p class="card-text">内容: <%= @post.content %></p>
    
    <%# 🌟 編集・削除ボタンの表示制限 (要件 10) 🌟 %>
    <% if current_user == @post.user %>
      <%= link_to '編集', edit_post_path(@post), class: 'btn btn-warning me-2' %>
      <%= link_to '削除', post_path(@post), 
                  method: :delete, 
                  data: { confirm: '本当に削除してもよろしいですか？' }, # 削除前の確認 (要件 9)
                  class: 'btn btn-danger' %>
    <% end %>
    <p>この投稿へのいいね数: <%= @post.likes.count %></p>

    <% if user_signed_in? %> 
      <% if current_user.already_liked?(@post) %>
        <%= link_to '❤️ いいね！解除', post_likes_path(@post), method: :delete, class: 'btn btn-secondary' %>
      <% else %>
        <%= link_to '♡ いいね！', post_likes_path(@post), method: :post, class: 'btn btn-danger' %>
      <% end %>
    <% end %>
    <% if user_signed_in? %>
      <h3>コメントを追加</h3>
      <%= form_with(model: [@post, Comment.new], local: true) do |form| %>
        <div class="form-group">
          <%= form.text_area :content, rows: 3, class: "form-control", placeholder: "コメントを入力..." %>
        </div>
        <br>
        <%= form.submit "コメント投稿", class: "btn btn-success" %>
      <% end %>
    <% end %>
    <hr>
    <h3>コメント (<%= @post.comments.count %>件)</h3>

    <% @post.comments.includes(:user).order(created_at: :asc).each do |comment| %>
      <div class="card mb-2">
        <div class="card-body">
          <p class="card-text"><%= comment.content %></p>
          <p class="text-muted small">
            投稿者: <%= comment.user.name %> | 
            投稿日時: <%= comment.created_at.strftime("%Y/%m/%d %H:%M") %>
            
            <% if comment.user == current_user %>
              <%= link_to '削除', [@post, comment], method: :delete, 
                          data: { confirm: '本当に削除しますか？' }, 
                          class: 'btn btn-danger btn-sm float-right' %>
            <% end %>
          </p>
        </div>
      </div>
    <% end %>
    
    <%= link_to '一覧に戻る', posts_path, class: 'btn btn-secondary mt-3' %>
  </div>
</div>