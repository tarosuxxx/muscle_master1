<div class="container my-5">
  
  <h1 class="fw-bolder mb-4 border-bottom pb-2 text-dark">
    <i class="fas fa-search me-2 text-orange"></i>投稿詳細
  </h1>

  <div class="row post-detail-container">

    <%# ========== 左側: 動画と投稿内容 (col-lg-8) ========== %>
    <div class="col-lg-7 mb-4"> <%# col-md-7からcol-lg-7に変更 %>
      
      <%# 1. 動画プレイヤーエリア %>
      <div class="video-player-area mb-4 rounded shadow-lg bg-dark">
        <% if @post.video.attached? %>
          <video controls class="w-100 rounded-top" style="max-height: 500px; object-fit: contain;">
              <source src="<%= url_for(@post.video) %>" type="<%= @post.video.content_type %>">
              お使いのブラウザは動画タグをサポートしていません。
          </video>
        <% else %>
          <div class="p-5 text-center text-white" style="min-height: 350px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
              <i class="fas fa-video-slash fa-4x mb-3"></i>
              <p class="mb-0 fs-5">動画ファイルはありません</p>
          </div>
        <% end %>
      </div>
      
      <%# 2. 投稿者情報といいねアクション %>
      <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-white border rounded shadow-sm">
        
        <%# 投稿者情報 %>
        <div class="d-flex align-items-center">
          <i class="fas fa-user-circle fa-2x me-2 text-muted"></i>
          <p class="mb-0 fw-bold">投稿者: 
            <%= link_to @post.user.name, user_path(@post.user), class: 'text-primary' %>
          </p>
          <p class="mb-0 small text-muted ms-3">投稿日: <%= @post.created_at.strftime("%Y/%m/%d") %></p>
        </div>
        
        <%# いいねボタン（強調とAjax対応） %>
        <div class="d-flex align-items-center" id="like-area-<%= @post.id %>">
          <span class="badge bg-danger p-2 me-3 fs-6"><i class="fas fa-heart me-1"></i> <%= @post.likes.count %></span>
          <% if user_signed_in? %> 
              <%# 実際にはいいねボタンをレンダリングするパーシャルをここに配置する方がクリーンです %>
              <% if current_user.already_liked?(@post) %>
                  <%= link_to '解除', post_likes_path(@post), method: :delete, remote: true, class: 'btn btn-sm btn-outline-danger' %>
              <% else %>
                  <%= link_to 'いいね！', post_likes_path(@post), method: :post, remote: true, class: 'btn btn-sm btn-danger fw-bold' %>
              <% end %>
          <% end %>
        </div>
      </div>
      
      <%# 3. 投稿内容カード %>
      <div class="card p-4 shadow-sm mb-4">
        
        <h4 class="fw-bold mb-3 border-bottom pb-1 text-secondary">
          <i class="fas fa-edit me-2"></i>意識しているポイント
        </h4>
        <p class="lead text-break"><%= simple_format(@post.content) %></p> 

        <h4 class="fw-bold mb-3 mt-4 border-bottom pb-1 text-secondary">
          <i class="fas fa-hand-rock me-2"></i>トレーニング部位
        </h4>
        <div class="d-flex flex-wrap">
          <% if @post.parts.any? %>
            <% @post.parts.each do |part| %>
              <span class="badge bg-success me-2 mb-2 p-2 fw-normal"><%= part.name %></span>
            <% end %>
          <% else %>
            <p class="text-muted small fst-italic">選択された部位はありません。</p>
          <% end %>
        </div>
        
        <hr class="my-4">
        
        <%# 4. 編集/削除/戻るボタン %>
        <div class="d-flex justify-content-end">
          <% if current_user == @post.user %>
            <%= link_to '編集', edit_post_path(@post), class: 'btn btn-warning me-2' %>
            <%= link_to '削除', post_path(@post), 
                                method: :delete, 
                                data: { confirm: '本当に削除してもよろしいですか？' },
                                class: 'btn btn-danger me-4' %>
          <% end %>
          <%= link_to '一覧に戻る', posts_path, class: 'btn btn-outline-secondary' %>
        </div>
        
      </div>
      
    </div>

    <%# ========== 右側: コメントエリア (col-lg-5) ========== %>
    <div class="col-lg-5">
      <div class="card p-4 shadow-lg sticky-top" style="top: 80px;"> <%# コメント欄を追従させる %>
        
        <h4 class="fw-bold mb-3 border-bottom pb-2 text-info">
          <i class="fas fa-comments me-2"></i>コメント (<%= @post.comments.count %>件)
        </h4>

        <%# 1. コメント投稿フォーム %>
        <% if user_signed_in? %>
          <%= form_with(model: [@post, Comment.new], remote: true, class: "mb-4") do |form| %> <%# remote: trueを推奨 %>
              <div class="form-group mb-2">
                  <%= form.text_area :content, rows: 3, class: "form-control", placeholder: "コメントを入力..." %>
              </div>
              <%= form.submit "コメント投稿", class: "btn btn-info w-100 shadow-sm" %>
          <% end %>
        <% else %>
          <div class="alert alert-light text-center small mb-4">
            コメントを投稿するには<span class="fw-bold">サインイン</span>が必要です。
          </div>
        <% end %>
        
        <hr class="my-3">

        <%# 2. コメント一覧 %>
        <div id="comments-area" class="mt-4" style="max-height: 400px; overflow-y: auto;">
            <% if @post.comments.any? %>
                <% @post.comments.includes(:user).order(created_at: :asc).each do |comment| %>
                    <div class="card mb-3 comment-card border-light shadow-sm">
                        <div class="card-body p-3">
                            <p class="card-text mb-2"><%= comment.content %></p>
                            <div class="d-flex justify-content-between align-items-center border-top pt-2">
                                <p class="text-muted small mb-0">
                                    <i class="fas fa-user small me-1"></i><strong><%= link_to comment.user.name, user_path(comment.user), class: 'text-primary' %></strong> | 
                                    <%= comment.created_at.strftime("%Y/%m/%d %H:%M") %>
                                </p>
                                <% if comment.user == current_user %>
                                    <%= link_to '削除', [@post, comment], method: :delete, 
                                            data: { confirm: '本当に削除しますか？', remote: true }, 
                                            class: 'btn btn-outline-danger btn-sm p-1 px-2' %>
                                <% end %>
                            </div>
                        </div>
                    </div>
                <% end %>
            <% else %>
                <p class="text-center text-muted fst-italic py-3">まだコメントはありません。一番にフィードバックを送りましょう！</p>
            <% end %>
        </div>

      </div>
    </div>
    
  </div>
</div>